<div class="transactions-page-container" data-controller="shortcuts-help skeleton-loading" data-action="turbo:submit-start@document->skeleton-loading#show turbo:frame-load@document->skeleton-loading#hide">
  <header class="transactions-header">
    <div>
      <h1 class="transactions-title">Gastos Pendientes</h1>
      <p class="transactions-subtitle">Revisa y categoriza tus √∫ltimos movimientos para InfluxDB.</p>
    </div>
    <div class="transactions-header-right">
      <%= form_with url: transactions_path, method: :get, local: true,
          data: { controller: "search", turbo_action: "advance", turbo_frame: "transactions_list" },
          class: "transactions-filters-form" do |f| %>
        <%= f.hidden_field :sort, value: params[:sort] || "fecha_desc" if !@pending.any? %>
        <div class="search-field-wrapper">
          <span class="search-icon">üîç</span>
          <%= f.text_field :q,
              value: params[:q],
              placeholder: "Buscar en detalles...",
              autocomplete: "off",
              class: "input-search-ux search-input-with-icon",
              data: { action: "input->search#submit" } %>
        </div>
        <div class="transactions-filter-date">
          <%= f.date_field :fecha, value: params[:fecha], class: "transactions-filter-input",
              data: { action: "change->search#submit" } %>
        </div>
        <div class="transactions-filter-monto">
          <%= f.number_field :monto_min, value: params[:monto_min], placeholder: "M√≠n", step: 0.01, class: "transactions-filter-input transactions-filter-monto-input",
              data: { action: "change->search#submit" } %>
          <%= f.number_field :monto_max, value: params[:monto_max], placeholder: "M√°x", step: 0.01, class: "transactions-filter-input transactions-filter-monto-input",
              data: { action: "change->search#submit" } %>
        </div>
        <% if @categories_for_filter.any? %>
          <div class="transactions-filter-cat">
            <%= f.select :categoria,
                options_for_select([ ["Todas las categor√≠as", ""] ] + @categories_for_filter.map { |c| [ c, c ] }, params[:categoria]),
                {},
                { class: "transactions-sort-select", data: { action: "change->search#submit" } } %>
          </div>
        <% end %>
        <% if @pending.any? %>
          <div class="transactions-sort">
            <label for="sort-select" class="transactions-sort-label">Orden:</label>
            <%= f.select :sort,
                options_for_select([
                  ["Por fecha (reciente)", "fecha_desc"],
                  ["F√°ciles primero", "faciles_primero"],
                  ["Monto ascendente", "monto_asc"],
                  ["Monto descendente", "monto_desc"]
                ], params[:sort] || "fecha_desc"),
                {},
                { id: "sort-select", class: "transactions-sort-select", onchange: "this.form.submit()" } %>
          </div>
        <% end %>
      <% end %>
      <%= render "transactions/progress", pending_count: @pending_count, approved_count: @approved_count, approved_this_week: @approved_this_week, total_count: @total_count %>
      <button type="button" class="transactions-help-btn" data-action="click->shortcuts-help#open" data-shortcuts-help-target="trigger" title="Atajos de teclado (?)">?</button>
    </div>
  </header>

  <div class="transactions-frame-wrapper">
    <%= turbo_frame_tag "transactions_list" do %>
  <% if @pending.any? %>
    <div id="transactions-container" class="transactions-grid" data-controller="transactions-keyboard">
      <% @pending.each do |t| %>
        <%= render "shared/transaction_card", transaction: t, suggested: @suggested[t.id] do %>
          <div data-controller="auto-save approve transaction-validation approve-similar"
               data-auto-save-url-value="<%= transaction_path(t) %>"
               data-approve-similar-categoria-value="<%= @suggested[t.id]&.dig(:category) %>"
               data-approve-similar-sub-categoria-value="<%= @suggested[t.id]&.dig(:sub_category) %>"
               data-approve-similar-sentimiento-value="<%= @suggested[t.id]&.dig(:sentimiento) %>"
               data-approve-similar-preview-url-value="<%= approve_similar_preview_transactions_path %>"
               data-approve-similar-url-value="<%= approve_similar_transactions_path %>"
               class="transaction-approval-wrapper">
            <%= form_with model: t, url: approve_transaction_path(t), method: :patch,
                          html: { class: "transaction-approval-form", data: { turbo: false, auto_save_target: "form", approve_target: "form" } } do |f| %>
              <div class="approval-form-box">
                <%= render "shared/transaction_form_fields",
                          f: f,
                          categories_map: @categories_map,
                          categories_list: @categories_list,
                          suggested: @suggested[t.id],
                          transaction: t,
                          auto_save: true,
                          approve_similar: true %>

                <div class="approval-form-submit">
                  <span data-auto-save-target="status" class="auto-save-status"></span>
                  <button type="button" data-auto-save-target="retryButton" data-action="click->auto-save#retry" class="btn-retry" style="display: none;">Reintentar</button>
                  <%= f.submit "‚úÖ Aprobar Transacci√≥n", class: "btn-submit-primary", data: { transaction_validation_target: "submit" } %>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      <% end %>
    </div>
  <% else %>
    <% if params[:q].present? %>
      <%= render "shared/empty_state", 
            icon: "üîç",
            title: "Sin resultados",
            message: "No hay transacciones que coincidan con tu b√∫squeda." %>
    <% else %>
      <%= render "shared/empty_state", 
            icon: "üéâ",
            title: "¬°Todo procesado!",
            message: "No hay gastos pendientes de aprobaci√≥n." %>
    <% end %>
  <% end %>
  <% end %>
    <div id="skeleton-overlay" class="skeleton-overlay" aria-hidden="true">
      <div class="skeleton-overlay-grid transactions-grid"></div>
    </div>
  </div>

  <%= render "transactions/shortcuts_help_modal" %>
  <div id="modal-container"></div>

  <div id="cards-restore-buffer" aria-hidden="true" style="display: none;"></div>
  <template id="skeleton-cards-template">
    <%= render "shared/skeleton_transaction_card" %>
  </template>
</div>