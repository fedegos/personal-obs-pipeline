<!-- app/views/source_files/index.html.erb -->
<%# Usamos la constante definida en config/initializers/bank_schemas.rb %>
<div data-controller="parameters" data-parameters-schemas-value="<%= BANK_SCHEMAS.to_json %>">

  
  <header style="margin-bottom: 32px;">
    <h1 style="margin: 0; color: #1e293b; font-size: 1.875rem; font-weight: 700;">üì§ Ingesta de Datos</h1>
    <p style="color: #64748b; margin-top: 8px;">Sube archivos para procesamiento autom√°tico v√≠a Pipeline 2026.</p>
  </header>

  <!-- SECCI√ìN DE CARGA -->
  <section style="background: white; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 24px; margin-bottom: 32px;">
    <%= form_with url: source_files_path, method: :post, local: true, multipart: true do |f| %>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 24px;">
        
        <!-- Selector de Banco -->
        <div style="display: flex; flex-direction: column; gap: 8px;">
          <%= f.label :bank, "Banco Emisor", style: "font-weight: 600; color: #475569;" %>
          <%= f.select :bank, BANK_SCHEMAS.keys.map { |k| [k.upcase, k] }, 
            { prompt: 'Seleccionar Banco...' }, 
            { 
              style: "padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; background: #f8fafc;", 
              data: { 
                parameters_target: "bankSelect", 
                action: "change->parameters#showSchema" 
              } 
            } %>
        </div>

        <!-- Selector de Archivo -->
        <div style="display: flex; flex-direction: column; gap: 8px;">
          <%= f.label :file, "Archivo (Excel/CSV)", style: "font-weight: 600; color: #475569;" %>
          <%= f.file_field :file, style: "padding: 7px; border: 1px solid #cbd5e1; border-radius: 6px; background: #f8fafc;" %>
        </div>
      </div>

      <!-- CONTENEDOR DE PAR√ÅMETROS DIN√ÅMICOS -->
        <!-- Contenedor donde se inyectar√°n los clones -->
        <div data-parameters-target="schemaContainer" style="display: none; background: #f1f5f9; padding: 20px; border-radius: 8px; margin-bottom: 24px;">
            <h4 style="margin-top: 0; font-size: 0.8rem; color: #64748b; text-transform: uppercase;">Par√°metros del Extractor</h4>
            <div id="dynamic-fields" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <!-- Aqu√≠ se inyectan los campos -->
            </div>
        </div>


        <!-- TEMPLATE: Aqu√≠ vive el dise√±o. El JS no sabe de estilos, solo de este template. -->
        <template data-parameters-target="fieldTemplate">
            <div class="field-group" style="display: flex; flex-direction: column; gap: 4px;">
            <label style="font-size: 0.75rem; font-weight: 700; color: #475569;"></label>
            <input style="padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px;">
            </div>
        </template>


      <%= f.submit "üöÄ Iniciar Pipeline", style: "background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-weight: 600; cursor: pointer;" %>
    <% end %>
  </section>

  <!-- TABLA DE HISTORIAL -->
  <section style="background: white; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden;">
    <div style="padding: 16px 20px; border-bottom: 1px solid #e2e8f0; background: #f8fafc;">
      <h2 style="font-size: 1rem; color: #334155; margin: 0;">üìú Historial Reciente</h2>
    </div>
    <div style="overflow-x: auto;">
      <table style="width: 100%; border-collapse: collapse; text-align: left; font-size: 0.9rem;">
        <thead>
          <tr style="background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
            <th style="padding: 12px 20px; color: #64748b; font-weight: 600;">Fecha</th>
            <th style="padding: 12px 20px; color: #64748b; font-weight: 600;">Banco</th>
            <th style="padding: 12px 20px; color: #64748b; font-weight: 600;">Estado</th>
            <th style="padding: 12px 20px; color: #64748b; font-weight: 600;">Metadatos / Error</th>
          </tr>
        </thead>
        <tbody>
          <% @source_files.each do |sf| %>
            <tr style="border-bottom: 1px solid #f1f5f9;">
              <td style="padding: 12px 20px;"><%= sf.created_at.strftime("%d/%m/%y %H:%M") %></td>
              <td style="padding: 12px 20px;"><span style="background: #e2e8f0; padding: 3px 8px; border-radius: 4px; font-weight: bold;"><%= sf.bank.upcase %></span></td>
              <td style="padding: 12px 20px;">
                <% color = { 'pending' => '#f59e0b', 'processed' => '#10b981', 'failed' => '#ef4444' }[sf.status] %>
                <span style="color: <%= color %>; font-weight: 600;">‚óè <%= sf.status.capitalize %></span>
              </td>
              <td style="padding: 12px 20px; color: #64748b;">
                <code style="font-size: 0.8rem;"><%= sf.status == 'failed' ? sf.error_message : sf.extra_params.to_json %></code>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </section>
</div>
