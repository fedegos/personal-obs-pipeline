<!-- app/views/source_files/index.html.erb -->
<%# Usamos la constante definida en config/initializers/bank_schemas.rb %>
<div data-controller="parameters"
    data-parameters-schemas-value="<%= BANK_SCHEMAS.to_json %>"
    data-parameters-no-file-banks-value="<%= NO_FILE_BANKS.to_json %>"
    class="source-files-page"
>
  <%# Suscripci칩n al canal de Redis %>
  <%= turbo_stream_from "source_files_channel" %>

  <header class="page-header source-files-header">
    <div class="page-header-content">
      <h1 class="page-title source-files-title">游닋 Ingesta de Datos</h1>
      <p class="page-subtitle">Sube archivos para procesamiento autom치tico v칤a Pipeline 2026.</p>
    </div>
  </header>

  <!-- SECCI칍N DE CARGA -->
  <section class="source-files-upload-section" data-controller="upload-status">
    <%= form_with url: source_files_path, method: :post, local: true, multipart: true,
        data: { action: "submit->upload-status#submit" } do |f| %>
      
      <!-- GRID PRINCIPAL: Banco y Archivo -->
      <div class="source-files-form-grid">
        
        <!-- Selector de Banco -->
        <div class="source-files-field-group">
          <%= f.label :bank, "Banco Emisor", class: "source-files-label" %>
          <%= f.select :bank, BANK_SCHEMAS.keys.map { |k| [k.upcase, k] }, 
            { prompt: 'Seleccionar Banco...' }, 
            { 
              class: "source-files-select", 
              data: { 
                parameters_target: "bankSelect", 
                action: "change->parameters#showSchema" 
              } 
            } %>
        </div>

        <!-- Selector de Archivo + Drag & Drop -->
        <div class="source-files-field-group" data-controller="file-drop" data-file-drop-target="zone">
          <%= f.label :file, class: "file-drop-label", data: { parameters_target: "fileLabel" } do %>
            <span class="source-files-label" data-parameters-target="fileLabelText">Archivo (Excel/CSV)</span>
            <div class="file-drop-zone">
              <%= f.file_field :file, 
                  data: { parameters_target: "fileInput", file_drop_target: "input" },
                  class: "source-files-file-input" %>
              <span class="file-drop-hint">Arrastr치 un archivo aqu칤 o hace clic para elegir</span>
            </div>
          <% end %>
          <div data-file-drop-target="preview" class="file-drop-preview" style="display: none;"></div>
        </div>
      </div>

      <!-- SECCI칍N DIN츼MICA: Aparece solo si el banco tiene par치metros adicionales -->
      <div data-parameters-target="schemaContainer" class="source-files-schema-container">
          <h4 class="source-files-schema-title">Configuraci칩n Adicional</h4>
          
          <div id="dynamic-fields" class="source-files-dynamic-fields">
            <!-- El JS inyectar치 aqu칤 los campos del Template -->
          </div>
      </div>

      <!-- BOT칍N DE ACCI칍N -->
      <div class="source-files-form-footer">
        <%= f.submit "游 Iniciar Pipeline", class: "btn-pipeline-submit", data: { upload_status_target: "submit" } %>
        <span data-upload-status-target="status" class="upload-status-text" style="display: none;">Subiendo...</span>
      </div>

      <!-- TEMPLATE (Invisible para el usuario, usado por Stimulus) -->
      <template data-parameters-target="fieldTemplate">
          <div class="source-files-field-template">
            <label></label>
            <input>
          </div>
      </template>

    <% end %>
  </section>

  <!-- TABLA DE HISTORIAL -->
  <section class="source-files-history-section">
    <div class="source-files-history-header">
      <h2 class="source-files-history-title">游닆 Historial de Procesamiento</h2>
    </div>
    <div class="source-files-table-wrapper">
      <table class="source-files-table">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Extractor</th>
            <th>Estado</th>
            <th>Transacciones</th>
            <th>Detalles</th>
          </tr>
        </thead>
        <tbody id="source_files_table">
          <% @source_files.each do |sf| %>
            <%= render partial: "source_files/source_file", locals: { source_file: sf } %>
          <% end %>
        </tbody>
      </table>
    </div>
  </section>
</div>
