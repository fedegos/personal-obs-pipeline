<%# 
  suggested = hash en memoria (opción B) con category, sub_category, sentimiento del motor de reglas.
  Preferimos la sugerencia cuando el valor guardado está vacío o es el default "Varios" (nunca elegido por el usuario).
%>
<% suggested ||= {} %>
<%
  transaction = f.object
  # "Varios" es el default del motor cuando no hay match; si la transacción solo tiene eso, mostramos la sugerencia actual
  has_real_categoria = transaction.categoria.present? && transaction.categoria != 'Varios'
  display_categoria = has_real_categoria ? transaction.categoria : suggested[:category]
  display_subcategoria = transaction.sub_categoria.presence || suggested[:sub_category]
  display_sentimiento = (transaction.sentimiento.present? && Transaction::SENTIMIENTOS.key?(transaction.sentimiento)) ? transaction.sentimiento : suggested[:sentimiento]
  categoria_empty = display_categoria.blank?
  subcategoria_empty = display_subcategoria.blank?
  sentimiento_empty = display_sentimiento.blank? || !Transaction::SENTIMIENTOS.key?(display_sentimiento)
%>

<div data-controller="combo" class="form-combo-container">
  <div id="categories-data" data-map="<%= categories_map.to_json %>" class="hidden"></div>
  
  <datalist id="categories-suggestions">
    <% categories_list.each do |cat| %><option value="<%= cat %>"><% end %>
  </datalist>
  <datalist id="subcategories-suggestions"></datalist>

  <div class="form-grid-fields">
    <div class="form-field-group <%= 'form-field-required' if categoria_empty %>">
      <%= f.label :categoria, "Categoría", class: "form-label-caps" do %>
        Categoría
        <% if categoria_empty %>
          <span class="field-required-indicator" title="Campo requerido">*</span>
        <% end %>
      <% end %>
      <%= f.text_field :categoria,
          value: display_categoria,
          list: "categories-suggestions",
          data: { combo_target: "input", action: "input->combo#checkNew" },
          placeholder: categoria_empty ? "Ej: Hogar (requerido)" : "Ej: Hogar",
          autocomplete: "off",
          class: "form-input-modern #{'form-input-required' if categoria_empty}",
          required: categoria_empty %>
      <% if categoria_empty %>
        <span class="field-help-text">Clasifica el tipo de gasto</span>
      <% end %>
    </div>
    
    <div class="form-field-group <%= 'form-field-optional' if !categoria_empty && subcategoria_empty %>">
      <%= f.label :sub_categoria, "Subcategoría", class: "form-label-caps" do %>
        Subcategoría
        <span class="field-optional-indicator" title="Campo opcional pero recomendado">(opcional)</span>
      <% end %>
      <%= f.text_field :sub_categoria,
          value: display_subcategoria,
          list: "subcategories-suggestions",
          data: { combo_target: "subInput" },
          placeholder: "Sub...",
          class: "form-input-modern" %>
      <% if subcategoria_empty %>
        <span class="field-help-text">Detalla más específicamente el gasto</span>
      <% end %>
    </div>
  </div>

  <div class="form-field-group <%= 'form-field-required' if sentimiento_empty %>">
    <%= f.label :sentimiento, "Impacto / Sentimiento", class: "form-label-caps" do %>
      Impacto / Sentimiento
      <% if sentimiento_empty %>
        <span class="field-required-indicator" title="Campo requerido">*</span>
      <% end %>
    <% end %>
    <%= f.select :sentimiento,
          Transaction::SENTIMIENTOS.map { |k, v| [v, k] },
          { selected: display_sentimiento, prompt: sentimiento_empty ? "Seleccionar... (requerido)" : "Seleccionar..." },
          { class: "form-input-modern form-select-modern #{'form-input-required' if sentimiento_empty}",
            required: sentimiento_empty } %>
    <% if sentimiento_empty %>
      <span class="field-help-text">Clasifica el impacto financiero del gasto</span>
    <% end %>
  </div>
</div>