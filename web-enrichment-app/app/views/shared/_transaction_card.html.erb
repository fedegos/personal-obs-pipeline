<%# 
  suggested = hash en memoria (opci贸n B) con category, sub_category, sentimiento del motor de reglas.
  Si suggested est谩 presente, usamos esos valores para has_recommendation y badges; si no, usamos transaction.
%>
<% suggested ||= nil %>
<%
  is_complete = transaction.categoria.present? &&
                transaction.sub_categoria.present? &&
                transaction.sentimiento.present? &&
                Transaction::SENTIMIENTOS.key?(transaction.sentimiento)
  is_pending = !transaction.aprobado?
  # Valores efectivos: sugerencia en memoria si existe, sino los guardados en la transacci贸n
  eff_cat = suggested&.dig(:category).presence || transaction.categoria
  eff_sub = suggested&.dig(:sub_category).presence || transaction.sub_categoria
  eff_sent = suggested&.dig(:sentimiento).presence || transaction.sentimiento
  has_recommendation = eff_cat.present? && (eff_cat != 'Varios' || eff_sub.present?)
  card_state = if is_pending && has_recommendation
    'transaction-card-suggested'
  elsif (is_pending && !has_recommendation) || (!is_pending && !is_complete)
    'transaction-card-incomplete'
  else
    ''
  end
%>

<div id="<%= dom_id(transaction) %>" class="transaction-card <%= card_state %>">
  <div class="transaction-card-header">
    <div class="transaction-header-left">
      <span class="transaction-id-tag">ID: <%= transaction.event_id.last(10) %></span>
      <%# Badges de informaci贸n de tarjeta %>
      <div class="transaction-card-info-badges">
        <% if transaction.red.present? %>
          <span class="badge-network <%= transaction.red.downcase %>">
            <%= transaction.red %>
          </span>
        <% end %>
        <% if transaction.numero_tarjeta.present? %>
          <span class="badge-card-number">
             <%= transaction.numero_tarjeta %>
          </span>
        <% end %>
        <% if transaction.en_cuotas? && transaction.descripcion_cuota.present? %>
          <span class="badge-cuotas">
             Cuota <%= transaction.descripcion_cuota %>
          </span>
        <% end %>
        <% if transaction.moneda.present? %>
          <span class="badge-moneda">
             <%= transaction.moneda %>
          </span>
        <% end %>
      </div>
    </div>
    <span class="transaction-amount"><%= number_to_currency(transaction.monto) %></span>
  </div>

  <div class="transaction-card-body">
    <div class="transaction-details"><%= transaction.detalles %></div>
    <div class="transaction-date"><span></span> <%= transaction.fecha.strftime("%d %b, %Y") %></div>
  </div>

  <%# Contenedor de badges de categorizaci贸n (valores efectivos: sugerencia o transaction) %>
  <div class="transaction-badges-container">
    <% if is_pending && has_recommendation %>
      <span class="badge-suggested">Revisar sugerencia</span>
    <% end %>
    <% if eff_cat.present? %>
      <span class="badge-category-audit"><%= eff_cat %></span>
    <% elsif is_pending %>
      <span class="badge-incomplete">锔 Sin categor铆a</span>
    <% end %>

    <% if eff_sub.present? %>
      <span class="badge-subcategory-audit"><%= eff_sub %></span>
    <% elsif is_pending %>
      <span class="badge-incomplete">锔 Sin subcategor铆a</span>
    <% end %>

    <% if eff_sent.present? && Transaction::SENTIMIENTOS.key?(eff_sent) %>
      <span class="badge-feeling-audit">
        <%= Transaction::SENTIMIENTOS[eff_sent] %>
      </span>
    <% elsif is_pending %>
      <span class="badge-incomplete">锔 Sin sentimiento</span>
    <% end %>
  </div>

  <div class="transaction-card-footer">
    <%= yield %>
  </div>
</div>