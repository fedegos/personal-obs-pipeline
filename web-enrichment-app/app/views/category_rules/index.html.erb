<%# Motor de Reglas: single page con sticky header, filtro por sentimiento y edici√≥n en modal %>
<div class="category-rules-page">
  <div class="page-header-sticky">
    <header class="page-header">
      <div class="page-header-content">
        <h1 class="page-title">‚öôÔ∏è Motor de Reglas</h1>
        <p class="page-subtitle">Configura la l√≥gica de categorizaci√≥n autom√°tica.</p>
      </div>
      <div class="page-header-actions">
        <%= link_to export_category_rules_path, class: "btn-secondary-action", data: { turbo: false } do %>
          <span>üì§</span> <span>Exportar</span>
        <% end %>
        <details class="import-details">
          <summary class="btn-secondary-action"><span>üì•</span> <span>Importar</span></summary>
          <div class="import-form-wrapper">
            <%= form_with url: import_category_rules_path, method: :post, local: true, multipart: true, class: "import-form" do |f| %>
              <label class="import-form-label">Archivo JSON</label>
              <%= f.file_field :file, accept: "application/json", class: "import-form-file" %>
              <span class="import-form-or">o pegar JSON:</span>
              <%= f.text_area :json, rows: 4, placeholder: '[{ "name": "...", "pattern": "...", ... }]', class: "import-form-textarea" %>
              <%= f.submit "Importar reglas", class: "btn-primary-action btn-import-submit" %>
            <% end %>
          </div>
        </details>
        <%= link_to new_category_rule_path(format: :turbo_stream), class: "btn-primary-action", data: { turbo_prefetch: false } do %>
          <span>‚ûï</span> <span>Nueva Regla</span>
        <% end %>
      </div>
    </header>

    <%= form_with url: category_rules_path, method: :get, data: { controller: "category-rules-filter", turbo_frame: "_top" }, class: "category-rules-filter-form" do |f| %>
      <label for="filter_sentimiento" class="category-rules-filter-label">Filtrar por sentimiento:</label>
      <%= f.select :sentimiento,
            options_for_select(
              [["Todos", ""], ["‚Äî Sin definir", "_blank"]] + Transaction::SENTIMIENTOS.map { |k, v| [v, k] },
              params[:sentimiento]
            ),
            {},
            {
              id: "filter_sentimiento",
              class: "category-rules-filter-select",
              data: { action: "change->category-rules-filter#submit" }
            } %>
    <% end %>
  </div>

  <div id="category_rules_list" class="grid-single-column">
    <%= render partial: "rule_card", collection: @category_rules, as: :rule %>
  </div>
  <% if @category_rules.empty? %>
    <div id="category_rules_empty" class="category-rules-empty-wrapper">
      <%= render "shared/empty_state",
            simple: true,
            message: params[:sentimiento].present? ? "No hay reglas con ese sentimiento." : "No hay reglas configuradas a√∫n. Comienza creando una categor√≠a ra√≠z." %>
    </div>
  <% end %>
</div>

<div id="modal-container"></div>
